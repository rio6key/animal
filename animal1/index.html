<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>VR Forest Scene</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- animation-mixer (aframe-extras に含まれます) -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  </head>

  <body>
    <!-- マウスクリック用 -->
    <a-scene cursor="rayOrigin: mouse">
      <!-- アセット -->
      <a-assets>
        <img id="startImage" src="sample.png" />
        <a-asset-item id="base" src="bease2.glb"></a-asset-item>
      </a-assets>

      <!-- 空 -->
      <a-sky color="#b3e5ff"></a-sky>

      <!-- ベース（アニメーション付き） -->
      <a-entity gltf-model="#base"
                position="0 0 0"
                rotation="0 90 0"
                scale="10 10 10"
                animation-mixer>
      </a-entity>

      <!-- ライト -->
      <a-entity light="type: directional; intensity: 1.5" position="10 20 10"></a-entity>
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>

      <!-- カメラリグ（要求通りカメラ位置は変更しない） -->
      <a-entity id="cameraRig" position="5 -1.1 -7.9" rotation="0 180 0">
        <a-camera look-controls wasd-controls="acceleration:10"></a-camera>

        <!-- VRコントローラー -->
        <a-entity id="ctlR"
                  laser-controls="hand: right"
                  raycaster="objects: .clickable; lineColor: red;"></a-entity>

        <a-entity id="ctlL"
                  laser-controls="hand: left"
                  raycaster="objects: .clickable; lineColor: blue;"></a-entity>
      </a-entity>

      <!-- スタート画像（クリックでフェードアウト） -->
      <a-entity id="startImageEntity" position="5 0 -6.5">
        <a-image id="startImagePlane"
                 src="#startImage"
                 width="3"
                 height="2"
                 position="0 1.5 0"
                 rotation="0 180 0"
                 opacity="1"
                 class="clickable">
        </a-image>
      </a-entity>
    </a-scene>

    <!-- スクリプト：DOM と a-scene の読み込みを待ってから要素取得 -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const scene = document.querySelector('a-scene');

        // シーン（アセット含む）が読み込まれるのを待つ
        if (scene.hasLoaded) {
          setup();
        } else {
          scene.addEventListener('loaded', setup);
        }

        function setup() {
          const imgPlane = document.getElementById('startImagePlane');

          if (!imgPlane) return; // 念のためのガード

          // A-Frame のカーソル / レーザーで click イベントが飛ぶようにする
          // （デスクトップのマウスクリックや VR コントローラーのクリックの両方に対応）
          imgPlane.addEventListener('click', () => fadeOut(imgPlane));

          // フェードアウト関数（visible は boolean で扱う）
          function fadeOut(el) {
            const vis = el.getAttribute('visible');
            if (vis === false) return;

            let opacity = parseFloat(el.getAttribute('opacity')) || 1.0;
            const fade = setInterval(() => {
              opacity -= 0.05;
              if (opacity <= 0) {
                // A-Frame では boolean を直接セットするのが安全
                el.setAttribute('opacity', 0);
                el.setAttribute('visible', false);
                clearInterval(fade);
              } else {
                el.setAttribute('opacity', opacity);
              }
            }, 50);
          }
        }
      });
    </script>
  </body>
</html>
